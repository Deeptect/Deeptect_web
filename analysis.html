<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/analysis.css">
    <title>DeepTect - ë”¥í˜ì´í¬ ë¶„ì„</title>
    <style>

    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo" onclick="location.href='/'">
            <img src="DeepTect.png" alt="ë¡œê³ ">
            </div>
            <div class="actions">
            <!-- <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button> -->
            <button onclick="location.href='upLoad.html'">ì—…ë¡œë“œ</button>
            <button onclick="location.href='myPage.html'">ë§ˆì´í˜ì´ì§€</button>
            
            </div>
        </header>

        <div class="upload-section">
            <form id="uploadForm">
                <div class="form-group">
                    <label for="video">ì˜ìƒ íŒŒì¼ ì„ íƒ</label>
                    <input type="file" id="video" accept="video/*" required />
                </div>

                <div class="video-preview" id="videoPreview">
                    ğŸ“¹ ì˜ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”
                </div>

                <div class="form-group">
                    <label for="title">ì œëª©</label>
                    <input type="text" id="title" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 50ì)" maxlength="50" required />
                </div>

                <div class="form-group">
                    <label for="category">ì¹´í…Œê³ ë¦¬</label>
                    <select id="category" required>
                        <option value="">ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="ìŠ¤í¬ì¸ ">ìŠ¤í¬ì¸ </option>
                        <option value="ë‰´ìŠ¤">ë‰´ìŠ¤</option>
                        <option value="ì—°ì˜ˆ">ì—°ì˜ˆ</option>
                        <option value="ì •ì¹˜">ì •ì¹˜</option>
                        <option value="ì˜ˆìˆ ">ì˜ˆìˆ </option>
                    </select>
                </div>

                <div class="button-group">
                    <button type="button" id="analyzeAttention" class="btn btn-secondary">ğŸ§  Attention ë¶„ì„</button>
                    <button type="button" id="analyzeConvolution" class="btn btn-danger">âš¡ Convolution ë¶„ì„</button>
                </div>

                <div class="button-group" style="margin-top: 20px;">
                    <button type="submit" id="submitBtn" class="btn btn-primary" disabled>ğŸ“¤ ê²°ê³¼ ì—…ë¡œë“œ</button>
                </div>
            </form>

            <div id="status"></div>
        </div>

        <div class="results-container" id="resultsContainer" style="display: none;">
            <div class="result-card" id="attentionCard" style="display: none;">
                <div class="model-title">
                    <span class="model-icon">ğŸ§ </span>
                    Attention ëª¨ë¸
                </div>
                <div id="attentionBadge" class="prediction-badge">ë¶„ì„ ì¤‘...</div>
                
                <div class="probability-bars" id="attentionBars" style="display: none;">
                    <div class="prob-item">
                        <span class="prob-label">ì›ë³¸ í™•ë¥ </span>
                        <div class="prob-bar">
                            <div class="prob-fill original" id="attentionOriginalBar"></div>
                        </div>
                        <span class="prob-value" id="attentionOriginalValue">0%</span>
                    </div>
                    <div class="prob-item">
                        <span class="prob-label">ë”¥í˜ì´í¬ í™•ë¥ </span>
                        <div class="prob-bar">
                            <div class="prob-fill deepfake" id="attentionDeepfakeBar"></div>
                        </div>
                        <span class="prob-value" id="attentionDeepfakeValue">0%</span>
                    </div>
                </div>
            </div>

            <div class="result-card" id="convolutionCard" style="display: none;">
                <div class="model-title">
                    <span class="model-icon">âš¡</span>
                    Convolution ëª¨ë¸
                </div>
                <div id="convolutionBadge" class="prediction-badge">ë¶„ì„ ì¤‘...</div>
                
                <div class="probability-bars" id="convolutionBars" style="display: none;">
                    <div class="prob-item">
                        <span class="prob-label">ì›ë³¸ í™•ë¥ </span>
                        <div class="prob-bar">
                            <div class="prob-fill original" id="convolutionOriginalBar"></div>
                        </div>
                        <span class="prob-value" id="convolutionOriginalValue">0%</span>
                    </div>
                    <div class="prob-item">
                        <span class="prob-label">ë”¥í˜ì´í¬ í™•ë¥ </span>
                        <div class="prob-bar">
                            <div class="prob-fill deepfake" id="convolutionDeepfakeBar"></div>
                        </div>
                        <span class="prob-value" id="convolutionDeepfakeValue">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="warningMessage" class="warning-text" style="display: none;">
            âš ï¸ ë‘ ëª¨ë¸ì˜ ê²°ê³¼ê°€ ìƒì´í•©ë‹ˆë‹¤. ì¶”ê°€ ê²€ì¦ì´ ê¶Œì¥ë©ë‹ˆë‹¤.
        </div>
    </div>

    <!-- ê²°ê³¼ ì•Œë¦¼ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="resultModal">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon">ğŸš¨</div>
            <h2 class="modal-title" id="modalTitle">ë”¥í˜ì´í¬ ê°ì§€!</h2>
            <p class="modal-description" id="modalDescription">ì´ ì˜ìƒì€ ì¡°ì‘ëœ ê²ƒìœ¼ë¡œ íŒë‹¨ë©ë‹ˆë‹¤</p>
            
            <div class="confidence-circle" id="confidenceCircle">
                <div class="confidence-text" id="confidenceText">85%</div>
            </div>
            <div class="confidence-label">ë¶„ì„ ì‹ ë¢°ë„</div>
            
            <button class="modal-close" onclick="closeModal()">í™•ì¸</button>
        </div>
    </div>

    <script>
        const videoInput = document.getElementById("video");
        const preview = document.getElementById("videoPreview");
        const analyzeAttentionBtn = document.getElementById("analyzeAttention");
        const analyzeConvolutionBtn = document.getElementById("analyzeConvolution");
        const submitBtn = document.getElementById("submitBtn");
        const statusDiv = document.getElementById("status");
        const form = document.getElementById("uploadForm");
        const resultsContainer = document.getElementById("resultsContainer");
        const warningMessage = document.getElementById("warningMessage");

        let attentionResult = null;
        let convolutionResult = null;

        // ì˜ìƒ íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸°
        videoInput.addEventListener("change", () => {
            const file = videoInput.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                preview.innerHTML = `<video src="${url}" controls style="width: 100%; height: 100%; border-radius: 15px;"></video>`;
                resetResults();
                updateStatus("ì˜ìƒì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ë”¥í˜ì´í¬ ë¶„ì„ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.", "info");
            }
        });

        // ë¶„ì„ ë²„íŠ¼ ì´ë²¤íŠ¸
        analyzeAttentionBtn.addEventListener("click", () => analyze("attention"));
        analyzeConvolutionBtn.addEventListener("click", () => analyze("convolution"));

        // ë¶„ì„ í•¨ìˆ˜
        async function analyze(type) {
            const videoFile = videoInput.files[0];
            const title = document.getElementById("title").value;
            
            if (!videoFile || !title) {
                alert("ì˜ìƒê³¼ ì œëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            const formData = new FormData();
            formData.append("video", videoFile);

            updateStatus(`${type} ëª¨ë¸ ë¶„ì„ ì¤‘...`, "info");
            showAnalysisCard(type);

            try {
                const accessToken = localStorage.getItem("accessToken");
                const response = await fetch(`https://zdznessqpctcnxhj.tunnel.elice.io/api/v1/video/analysis/${type}`, {
                    method: "POST",
                    headers: {
                        Authorization: `Bearer ${accessToken}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || `HTTP ${response.status}`);
                }

                const result = await response.json();
                const analysisResult = result.result || result.data || result;

                if (type === "attention") {
                    attentionResult = analysisResult;
                    updateAnalysisResult("attention", analysisResult);
                } else {
                    convolutionResult = analysisResult;
                    updateAnalysisResult("convolution", analysisResult);
                }

                // ë¶„ì„ ì™„ë£Œ í›„ ëª¨ë‹¬ í‘œì‹œ
                showResultModal(type, analysisResult);

                checkAnalysisComplete();
                updateStatus(`${type} ëª¨ë¸ ë¶„ì„ ì™„ë£Œ!`, "success");

            } catch (error) {
                console.error(`${type} ë¶„ì„ ì˜¤ë¥˜:`, error);
                updateStatus(`âŒ ${type} ë¶„ì„ ì‹¤íŒ¨: ${error.message}`, "error");
            }
        }

        // ê²°ê³¼ ëª¨ë‹¬ í‘œì‹œ
        function showResultModal(type, result) {
            const originalProb = Math.round((result.original_prob || 0) * 100);
            const deepfakeProb = Math.round((result.deepfake_prob || 0) * 100);
            const isDeepfake = result.prediction || deepfakeProb > originalProb;
            const confidence = Math.max(originalProb, deepfakeProb);

            const modal = document.getElementById('resultModal');
            const modalIcon = document.getElementById('modalIcon');
            const modalTitle = document.getElementById('modalTitle');
            const modalDescription = document.getElementById('modalDescription');
            const confidenceCircle = document.getElementById('confidenceCircle');
            const confidenceText = document.getElementById('confidenceText');

            if (isDeepfake) {
                modalIcon.textContent = 'ğŸš¨';
                modalTitle.textContent = 'ë”¥í˜ì´í¬ ê°ì§€!';
                modalTitle.className = 'modal-title';
                modalDescription.textContent = 'ì´ ì˜ìƒì€ ì¡°ì‘ëœ ê²ƒìœ¼ë¡œ íŒë‹¨ë©ë‹ˆë‹¤';
                confidenceCircle.className = 'confidence-circle';
            } else {
                modalIcon.textContent = 'âœ…';
                modalTitle.textContent = 'ì›ë³¸ ì˜ìƒ';
                modalTitle.className = 'modal-title safe';
                modalDescription.textContent = 'ì´ ì˜ìƒì€ ì›ë³¸ìœ¼ë¡œ íŒë‹¨ë©ë‹ˆë‹¤';
                confidenceCircle.className = 'confidence-circle safe';
            }

            confidenceText.textContent = `${confidence}%`;
            confidenceCircle.style.setProperty('--progress', `${confidence * 3.6}deg`);

            modal.classList.add('active');
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('resultModal').classList.remove('active');
        }

        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ì‹œ ë‹«ê¸°
        document.getElementById('resultModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                closeModal();
            }
        });

        // ë¶„ì„ ê²°ê³¼ ì¹´ë“œ í‘œì‹œ
        function showAnalysisCard(type) {
            resultsContainer.style.display = "grid";
            document.getElementById(`${type}Card`).style.display = "block";
        }

        // ë¶„ì„ ê²°ê³¼ ì—…ë°ì´íŠ¸
        function updateAnalysisResult(type, result) {
            const originalProb = Math.round((result.original_prob || 0) * 100);
            const deepfakeProb = Math.round((result.deepfake_prob || 0) * 100);
            const isDeepfake = result.prediction || deepfakeProb > originalProb;

            // ë°°ì§€ ì—…ë°ì´íŠ¸
            const badge = document.getElementById(`${type}Badge`);
            badge.textContent = isDeepfake ? "ë”¥í˜ì´í¬ ê°ì§€ë¨" : "ì›ë³¸ ì˜ìƒ";
            badge.className = `prediction-badge ${isDeepfake ? "danger" : "safe"}`;

            // í™•ë¥  ë°” ì—…ë°ì´íŠ¸
            const bars = document.getElementById(`${type}Bars`);
            bars.style.display = "block";

            document.getElementById(`${type}OriginalBar`).style.width = `${originalProb}%`;
            document.getElementById(`${type}OriginalValue`).textContent = `${originalProb}%`;
            document.getElementById(`${type}DeepfakeBar`).style.width = `${deepfakeProb}%`;
            document.getElementById(`${type}DeepfakeValue`).textContent = `${deepfakeProb}%`;
        }

        // ë¶„ì„ ì™„ë£Œ í™•ì¸
        function checkAnalysisComplete() {
            if (attentionResult && convolutionResult) {
                submitBtn.disabled = false;
                
                // ê²°ê³¼ ë¶ˆì¼ì¹˜ ê²½ê³ 
                const attentionIsDeepfake = attentionResult.prediction || 
                    (attentionResult.deepfake_prob || 0) > (attentionResult.original_prob || 0);
                const convolutionIsDeepfake = convolutionResult.prediction || 
                    (convolutionResult.deepfake_prob || 0) > (convolutionResult.original_prob || 0);
                
                if (attentionIsDeepfake !== convolutionIsDeepfake) {
                    warningMessage.style.display = "block";
                }
            }
        }

        // í¼ ì œì¶œ
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            if (!attentionResult || !convolutionResult) {
                alert("ë‘ ë¶„ì„ ëª¨ë‘ ì™„ë£Œë˜ì–´ì•¼ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                return;
            }

            const videoFile = videoInput.files[0];
            const title = document.getElementById("title").value;
            const category = document.getElementById("category").value;

            const formData = new FormData();
            formData.append("video", videoFile);
            formData.append("title", title);
            formData.append("category", category);
            formData.append("attention", true);
            formData.append("attention_pred", attentionResult.prediction ?? false);
            formData.append("attention_og_prob", attentionResult.original_prob ?? 0.0);
            formData.append("attention_df_prob", attentionResult.deepfake_prob ?? 0.0);
            formData.append("convolution", true);
            formData.append("convolution_pred", convolutionResult.prediction ?? false);
            formData.append("convolution_og_prob", convolutionResult.original_prob ?? 0.0);
            formData.append("convolution_df_prob", convolutionResult.deepfake_prob ?? 0.0);

            updateStatus("ì˜ìƒ ì—…ë¡œë“œ ì¤‘...", "info");

            try {
                const accessToken = localStorage.getItem("accessToken");
                const response = await fetch("https://zdznessqpctcnxhj.tunnel.elice.io/api/v1/video/upload", {
                    method: "POST",
                    headers: {
                        Authorization: `Bearer ${accessToken}`,
                    },
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error("ì—…ë¡œë“œ ì‹¤íŒ¨");
                }

                updateStatus("âœ… ì—…ë¡œë“œ ì„±ê³µ!", "success");
                resetForm();

            } catch (error) {
                console.error("ì—…ë¡œë“œ ì˜¤ë¥˜:", error);
                updateStatus("âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: " + error.message, "error");
            }
        });

        // ìƒíƒœ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
        function updateStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
        }

        // ê²°ê³¼ ì´ˆê¸°í™”
        function resetResults() {
            attentionResult = null;
            convolutionResult = null;
            submitBtn.disabled = true;
            resultsContainer.style.display = "none";
            warningMessage.style.display = "none";
            
            // ì¹´ë“œë“¤ ìˆ¨ê¸°ê¸°
            document.getElementById("attentionCard").style.display = "none";
            document.getElementById("convolutionCard").style.display = "none";
        }

        // í¼ ì´ˆê¸°í™”
        function resetForm() {
            form.reset();
            preview.innerHTML = "ğŸ“¹ ì˜ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”";
            resetResults();
            statusDiv.textContent = "";
            statusDiv.className = "";
        }
    </script>
</body>
</html>